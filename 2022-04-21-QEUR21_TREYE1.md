## QEUR21_TREYE1 – 再オリエンテーション～旧プロジェクト技術明細書（日本語版）

## ～　補足事項　～

### ・・・　前回の続きです　・・・

D先生 ： “・・・で、現代における「生産力」ってなにか？ 対応力、予知力・・・、つまり「自動検査力」でしょ？”

QEU:FOUNDER ： “そう、これが我々が自動検査プロジェクトを始める前提になります。・・・って、わかりにくいかな？自動検査には**DX（Digital Transformation）技術**が不可欠になります。”

![image3-11-0](https://yaber1965.github.io/images/image3-11-0.jpg)

D先生 ： “いまのＶＲ技術を使えば90％ぐらいの不良モードを量産以前に学習完了できます。ただし、それを可能にするには設計部門がＶＲを使いこなすこと、ＶＲデータを量産部門と共有することになります。”

QEU:FOUNDER ： “いっそのところ、設計部門と量産部門を統合すれば？自動化技術が一気に進むわけだし・・・。”

## ～　緒言　～

本技術明細書は、QEUプロジェクトが過去に開発した「ファイブ・アイズ検査技術」の内容をまとめたものです。

ちなみに、これは全く技術的に参考にならないですが、Youtube動画を添付します。

<iframe width="560" height="315" src="https://www.youtube.com/embed/q6cvkhhSeBA" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyro-scope; picture-in-picture" allowfullscreen></iframe>

[＞寄付のお願い(別ブログに飛びます)＜](https://jpnqeur21vinsp.blogspot.com/2022/04/qeur21treye1.html)

## ～　以下、本文　～

### 【発明の名称】　

画像認識法(異常検出性能とロバスト性の向上及びより簡単な判別方法)

### 【技術分野】  

本発明はコンピューターによる画像認識および判別技術一般に関するものです。

### 【背景技術】

コンピューターによる画像認識手法はAIコンテストなどを通じて新しい手法が次々と開発されており、最近ではﾃﾞｨｰﾌﾟﾗｰﾆﾝｸﾞが高性能な判別エンジンとして高く評価されています(図1)。


**(図1:画像認識技術の変遷)**

![image3-11-1](https://yaber1965.github.io/images/image3-11-1.jpg)

一般的な機械学習の解析フロー図を以下に示します(図2)。入力データの前処理も認識技術にとって重要な技術ですが、あまり進歩がありませんでした。

### (図2:機械学習のフローチャート)

![image3-11-2](https://yaber1965.github.io/images/image3-11-2.jpg)

データの前処理の主な方法を下表に示します（図3、4）。画像の情報量を圧縮する方法としては、現在のところ主成分分析（PCA）により寄与率の低い高次の主成分を削除することが一般的です。

**(図3：データの前処理)**

![image3-11-3](https://yaber1965.github.io/images/image3-11-3.jpg)

**(図4:画像データの主な前処理方法)**

![image3-11-4](https://yaber1965.github.io/images/image3-11-4.jpg)

欠陥の位置を特定することは外観検査にとって非常に重要です。製品によっては画像差分という技術で簡単に検査でき、その代表例はPCB（プリント基板）の欠陥検出の場合です。PCBは平面（立体でない）であること、製品形状が完全に転写していること、さらに製品の位置決めが高精度にできるためです。

**(図5: PCBの外観検査)**

![image3-11-5](https://yaber1965.github.io/images/image3-11-5.jpg)

ただし、その3条件が満たされる製品はむしろ少なく、多くの製品は画像差分による外観検査の自動化はできません。

多次元データの判別分析に広く使われるマハラノビス距離の考え方を下図に示します（図6）。マハラノビス距離を判別に応用する場合にはしきい値を設定します。マハラノビス距離には、計算のために多量のデータが必要であること、多重共線性があると計算できない欠点があります。

**(図6: マハラノビス距離の考え方)**

![image3-11-6](https://yaber1965.github.io/images/image3-11-6.jpg)

さらにマハラノビス距離が計算できてもそれでユーザーが要求する判別性能が得られるとは限らない。その改善策としては、単位空間へのメンバ追加、見直しやデータの収集・計測方法そのものの見直しが必要になることがあります。

**(図7: マハラノビス距離における単位空間の役割)**

![image3-11-7](https://yaber1965.github.io/images/image3-11-7.jpg)

##【発明の概要】

### 【発明が解決しようとする課題】

コンピューターによる画像認識において、画像の分類（例：写真はイヌ、それともネコ？）をすることは容易になってきている。しかし、立体の物体に存在する部分的な異常を検出することは、まだ難しい場合があります。

工業品を外観検査して異常を検出する場合には、ごく一部の異常部位を除き、標準品と検査品の状況は全く同じです。そのため、製品の異常を判定するための情報（シグナル）量が非常に少なくなります。

一方、外観検査には多くの外乱（ノイズ）があります。代表例が被検物のシフト、回転、光源の状態です。**外観検査ではノイズがシグナルよりも大きくなりやすくなり、外観検査の判別が難しくなります。**

### 【課題を解決するための手段】

本発明は品質改善に使用されているタグチメソッドのひとつである**RT(Recognition Taguchi)法を改善して画像認識の前処理プロセスとして使用します。**ただし、従来法のように距離を計算するのではなく、合計5台のカメラの感度とSN比をX方向とY方向に処理します（図8）。このように５つのカメラ（目）を使用するので、以降、この発明をファイブアイズ法（略してFE法）と呼ぶことにします。

**（図8: ファイブ・アイズ法の考え方）**

![image3-11-8](https://yaber1965.github.io/images/image3-11-8.jpg)

**FE(Five Eyes)法**はすでに説明した「新両目法」の拡張です。両目法と新両目法の差異を以下に示しますが、その詳細の説明は関連した文書を参照してください（図9）。

**（図9：両目法と新両目法の比較）**

![image3-11-9](https://yaber1965.github.io/images/image3-11-9.jpg)

新両目法をX軸とY軸に拡張すると、ロバスト性が高く、立体感の検出が容易になります。それと同時に、X方向とY方向から同じメトリックスを解析することで、被検体の回転があっても高い判別能力が得られます。

外観検査機を使用する場合、できれば量産開始時に外観検査機を立ち上げておくことが望ましいです。しかし、製品開発のプロセスの期間で得られる製品検査データは多くないため、従来の手法では外観検査機は間に合いません。そこで、より少ないデータでも「そこそこの検査」ができる方法（新MT法）が必要です。

本発明の外観検査自動機の解析フローを以下に示します(図10)。処理フローの前半がFE法であり、後半が新MT法となります。

**（図10 ：本発明の解析ﾌﾛｰ[FE法+新MT法]）**

![image3-11-10](https://yaber1965.github.io/images/image3-11-10.jpg)

FE法が使用する単位空間の画像にはX方向画像とY方向画像の2種類があり、2台のカメラの画像を平均化処理することで得られます(図11)。

**(図11：単位空間の平均画像)**

![image3-11-11](https://yaber1965.github.io/images/image3-11-11.jpg)

FE法では、画像を適切に分割してRTメトリックスのマトリックスを計算します。下図では、画像を50x50画素に分割しており、メトリックスを評価してマスクファイルを生成します（図12）。この値が１になる位置が「計測セル(領域)」になります。

**（図12 ： マスクファイルの内容）**

![image3-11-12](https://yaber1965.github.io/images/image3-11-12.jpg)

各セルにおけるRTメトリックスの影響度を精密に評価するために直交表による実験計画を採用します (図13)。直交表を使えば、各セルの主効果を計算できます。

**（図13 ：直交表）**

![image3-11-13](https://yaber1965.github.io/images/image3-11-13.jpg)

標準の被検体(NORMAL)と異常(ERROR)な被検体の主効果からメトリックス差異が計算できます（図14）。そして差異が有意となる位置を解析してマスク・ファイルを形成し、データを抽出するために使用します（図15）。この有意の規準はユーザーが決定します。

**（図14 ：主効果の計算）**

![image3-11-14](https://yaber1965.github.io/images/image3-11-14.jpg)

**（図15 ： マスクファイルの内容）**

![image3-11-15](https://yaber1965.github.io/images/image3-11-15.jpg)

ここまでがファイブアイズ（FE）法の説明になります。さらにFE法で計算した主効果を検査員（オペレータ）に表示すれば、不良の状況がより明確になります。

新MT法へのインプットは、マスクファイルで抽出したRTメトリックス群です。このデータには**4種類のメトリックス（“X方向-感度差異”、“X方向-SN比差異”、 “Y方向-感度差異”、“Y方向-SN比差異”）**があります。以下の事例ではマスクファイルのデータ抽出数が13項目であるので、メトリックスの総計は13x4=52項目となります。(図16)

**（図16 ： 新MT法へのインプット）**

![image3-11-16](https://yaber1965.github.io/images/image3-11-16.jpg)

FE法のメトリックスは多重共線性が強いので、そのままではマハラノビス距離を計算するのに適しません。そこで、主成分分析を使って直交化をします。以下の事例では主成分の次元数は今回はマスク数と同じ13項目にしました(図17)。

**（図17 ：主成分分析の結果）**

![image3-11-17](https://yaber1965.github.io/images/image3-11-17.jpg)

上図に物体の回転量(XYZ)と被検体の変形量(Err)の値のデータを追加しました。上図の主成分は説明変数(Xs）となり、XYZ-Errが応答変数(Ys)になります。そして、T法(2)を用いて特性式(Ys=f(Xs))を解き、各項目の感度とSN比を計算します(図18)。

**（図18 ：T法による項目別SN比の計算結果）**

![image3-11-18](https://yaber1965.github.io/images/image3-11-18.jpg)

T法(2)で計算した項目別SN比が大きい項目(X:説明変数)は、応答変数(Y)への影響度が大きいことを示しています。ここで、XYZはノイズ(誤差因子)になるので、SN比が大きい主成分は判別には不要であり、Errはシグナル（信号因子）になるのでSN比が大きい主成分は判別に必要な主成分になります。

## 【実施例_1】

今回の事例で使用した三次元CGモデルの画像を以下に示します。このCGソフトウェアは仮想空間に複数のカメラを取り付けて同時に複数画像を撮影することができます(図19)。Pythonプログラムで入力した直交表に従い被検体をXYZ軸に回転して画像を撮影しました(図20)。

**（図19 : 三次元CG(Blender)モデル）**

![image3-11-19](https://yaber1965.github.io/images/image3-11-19.jpg)

**（図20 : 撮影した画像群）**

![image3-11-20](https://yaber1965.github.io/images/image3-11-20.jpg)

被検体は学習データ(TRAIN)と検証データ(TEST)として6種類作成しました（図21）。物体（オブジェクト）は、形状の一部が変形されたり、色が変更されたりしています（図22,23）。

**（図21 :　被検体の考え方）**

![image3-11-21](https://yaber1965.github.io/images/image3-11-21.jpg)

**（図22 : 学習データ(TRAIN)群）**

![image3-11-22](https://yaber1965.github.io/images/image3-11-22.jpg)

**（図23 : 検証データ(TEST)群）**

![image3-11-23](https://yaber1965.github.io/images/image3-11-23.jpg)

FE法ではRT法の両目法で各種メトリックス（感度合計、SN比合計、感度差異、SN比差異）をX方向とY方向の2種類計算します（図24,25）。同じ物体をX方向とY方向から計測しているため、X方向とY方向のメトリックスには多重共線性があります。

**(図24 :  X方向のRTメトリックス分布)**

![image3-11-24](https://yaber1965.github.io/images/image3-11-24.jpg)

**(図25  :  X方向のRTメトリックス分布)**

![image3-11-25](https://yaber1965.github.io/images/image3-11-25.jpg)

主成分の累積寄与率を以下に示します（図26）。今回は上位10件程度を使用する予定なのですが、これで60％以上の寄与率が得られるので問題ないと考えられます。（あとで、ノイズ成分を排除することに注意）

**(図26 : 主成分寄与率計算結果)**

![image3-11-26](https://yaber1965.github.io/images/image3-11-26.jpg)

新MT法ではマハラノビス距離の代わりに、T法による重要項目分析で最適化した主成分をつかってユーグリッド距離を計算します。数理的には主成分で計算したユーグリッド距離はマハラノビス距離と等価になります（図27）。

**(図27 : ユーグリッド距離とマハラノビス距離)**

![image3-11-27](https://yaber1965.github.io/images/image3-11-27.jpg)

主成分は新MT法に採用した**「誤差因子(ノイズ)、信号因子(シグナル)」の考え方に基づいて選択**されます（図28）。誤差因子の影響を受ける主成分を排除し、信号因子の影響を受ける主成分から距離を計算すればSN比があがります。

**（図28:新MT法のデータ最適化の考え方）**

![image3-11-28](https://yaber1965.github.io/images/image3-11-28.jpg)

**（図29 ：再掲～T法による項目別SN比の計算結果）**

![image3-11-29](https://yaber1965.github.io/images/image3-11-29.jpg)

原点にあたる単位空間を学習データ全体に選択し、すべての主成分（N=13）を使った場合のユーグリッド距離の分布を以下に示します。どのグループも基準グループ(色NORMAL,形NORMAL)と大きな差異がありません。

**（図30:単位空間-学習データ全体、主成分-全部）**

![image3-11-30](https://yaber1965.github.io/images/image3-11-30.jpg)

同じ単位空間の下で、XYZ軸の回転に関係する誤差因子の影響を受ける主成分を排除した距離ヒストグラムを以下に示します。正常データ群とエラーデータ群をより明確に分けることができました。

**（図31:単位空間-学習データ全体、主成分-選択）**

![image3-11-31](https://yaber1965.github.io/images/image3-11-31.jpg)

次は、単位空間を標準条件のデータ群に変えて同様に距離を計算しました。この場合の分布は、すべての主成分を使用した場合と選択した場合の両方ともに、上述の学習データ全部を単位空間にした場合と大きな差がありません。

**（図32:単位空間-標準データ群、主成分-全体）**

![image3-11-32](https://yaber1965.github.io/images/image3-11-32.jpg)

**（図33:単位空間-標準データ群、主成分-選択）**

![image3-11-33](https://yaber1965.github.io/images/image3-11-33.jpg)

このように、「新MTが定義する」単位空間と誤差因子を用いて距離を計算すれば、**比較的少数のデータを採取するだけで外観検査自動機を実施する**ことができます。ちなみに、従来のMT法ではMT法のデータ収集の原則は「均質」であり、有名なロシア文学であるトルストイの「アンナ・カレーニナ」の冒頭の句をキャッチフレーズにしています。

### 「幸福な家庭はすべて互いに似通ったものであり、不幸な家庭はどこもその不幸の趣がことなているものである」（木村浩訳　新潮文庫）

田口玄一が定義した均質の原則だけでは予測システムを効率的に構築することは難しいです。新MT法の定義はそれを補足し、さらにほかのタグチメソッドとの整合性を強化するものです。

## 【産業上の利用可能性】

本発明のうちファイブ・アイズ（FE法）は以前提案した新両目法の拡張であり立体物を対象とした画像認識技術に適用できます。特に、外観検査の自動化や自動車の自動運転などに使用すると効果があります。

直交表を作成して主効果を計測する方法は外観検査自動機に特に有効です。工業品の部分的な異常を検出する場合にはSN比が低くくなり。判別の正確度が悪くなります。そこで、あえて距離のしきい値を低く設定し過検出に設定し、同時に主効果を測定してユーザーに判定させることが有効になります（図34）。

**（図34：主効果を活用した外観検査機のロジック）**

![image3-11-34](https://yaber1965.github.io/images/image3-11-34.jpg)

主効果をユーザに表示する技術は、AIでは**LIME(Local Interpretable Model-Agnostic Explanations)という技術**に相当します（図35）。外観検査機の処理をブラックボックスにしないことで、ユーザーの外観検査機に対する信頼を高めることができます。

**（図35：主効果を活用した外観検査機のロジック）**

![image3-11-35](https://yaber1965.github.io/images/image3-11-35.jpg)

一方、新MT法は産業上のあらゆるｺﾝﾋﾟｭｰﾀ認識技術に適用できます。さらに、誤差因子を適切に設定することにより、本メトリックス（ユーグリッド距離）を品質改善に活用することもできます。

誤差因子はユーグリッド距離を小さくする方向に作用します。逆に言えば、その値を大きくすることは信号因子の影響が大きく、誤差因子の影響が小さくなります。すなわち、プロセスのSN比が大きくなります。

ユーグリッド距離は加法性がないメトリックスなのでパラメータ設計には使えません。しかし、重要な制御因子を検出するCS-T法に使用することは可能です。

